<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
	<link rel="stylesheet" href="font-awesome-4.0.3/css/font-awesome.css">
	
    <title>Dictée Magique</title>
	<style>

	body {
	  font-family: monospace;
	}
	
	#keyboard-type {
	  border-collapse: collapse;
	}
	
	#keyboard-type td, #keyboard-type th{
	  border:1px solid black;
	  width: 60px;
	  padding: 5px;
	}

	td.selected{
	  background-color: black;
	  color: white;
	}

	table {
	  border-collapse: separate;
	}

	#screen {
	  margin-bottom: 1em;
	}
	
	table td{
	  cursor: pointer;
	  width: 60px;
	  height: 60px;
	  border-collapse: 2px;
	  border:1px solid black;
	  border-radius: 5px 5px;
	  text-align:center;
	  vertical-align: middle;
	}

	td:hover{
	  background-color: #BBB;
	}

	#screen td:hover {
	  cursor: default;
	  background-color: transparent;
	}
	
	table td.letter{
	  font-size: 40PX;
	  font-weight: bold;
	}

	#options td {
	  width: 30px;
	  height: 30px;
	}
	</style>
  </head>
  <body>
	<table id="options">
	  <tr>
		<td class="sound on">
		  <i class="fa fa-volume-up fa-lg"></i>
		</td>
	  </tr>
	</table>
	<table id="screen">
	  <tr id="line1">
		<td class="letter c1"></td>
		<td class="letter c2"></td>
		<td class="letter c3"></td>
		<td class="letter c4"></td>
		<td class="letter c5"></td>
		<td class="letter c6"></td>
		<td class="letter c7"></td>
		<td class="letter c8"></td>
		<td class="letter c9"></td>
		<td class="letter c10"></td>
	  </tr>
	</table>
	<table class="keyboard" id="keyboard-abcdef">
	  <tr>
		<td class="azerty">clavier<br/>AZERTY</td><td class="abcdef selected">clavier<br/>ABCDEF</td>		
		<td>Rejoue</td><td>Répète</td><td>Aide</td>
		<td class="mystery">Mystère</td><td>Secret</td><td>Lettre</td><td>Dis-le</td><td>Epelle</td>
	  </tr>
	  <tr>
		<td class="letter A">A</td><td class="letter B">B</td><td class="letter C">C</td><td class="letter D">D</td><td class="letter E">E</td>
		<td class="letter F">F</td><td class="letter G">G</td><td class="letter H">H</td><td class="letter I">I</td><td class="letter J">J</td>
	  </tr>
	  <tr>
		<td class="letter K">K</td><td class="letter L">L</td><td class="letter M">M</td><td class="letter N">N</td><td class="letter O">O</td>
		<td class="letter P">P</td><td class="letter Q">Q</td><td class="letter R">R</td><td class="letter S">S</td><td class="letter T">T</td>
	  </tr>
	  <tr>
		<td class="letter U">U</td><td class="letter V">V</td><td class="letter W">W</td><td class="letter X">X</td><td class="letter Y">Y</td>
		<td class="letter Z">Z</td><td class="letter ">'</td><td class="letter">#</td><td>Efface</td><td>Essaie</td>
	  </tr>
	</table>
	<table class="keyboard" id="keyboard-azerty" style="display: none">
	  <tr>
		<td class="azerty">clavier<br/>AZERTY</td><td class="abcdef selected">clavier<br/>ABCDEF</td>		
		<td>Rejoue</td><td>Répète</td><td>Aide</td>
		<td>Mystère</td><td>Secret</td><td>Lettre</td><td>Dis-le</td><td>Epelle</td>
	  </tr>
	  <tr>
		<td class="letter A">A</td><td class="letter Z">Z</td><td class="letter E">E</td><td class="letter R">R</td><td class="letter T">T</td>
		<td class="letter Y">Y</td><td class="letter U">U</td><td class="letter I">I</td><td class="letter O">O</td><td class="letter P">P</td>
	  </tr>
	  <tr>
		<td class="letter Q">Q</td><td class="letter S">S</td><td class="letter D">D</td><td class="letter F">F</td><td class="letter G">G</td>
		<td class="letter H">H</td><td class="letter J">J</td><td class="letter K">K</td><td class="letter L">L</td><td class="letter M">M</td>
	  </tr>
	  <tr>
		<td class="letter W">W</td><td class="letter X">X</td><td class="letter C">C</td><td class="letter V">V</td><td class="letter B">B</td>
		<td class="letter N">N</td><td class="letter ">'</td><td class="letter">#</td><td>Efface</td><td>Essaie</td>
	  </tr>
	  <p>Utilisez plutôt Chrome pour avoir une jolie synthèse vocale (celle de Firefox est vraiment mauvaise hélas)</p>
	</table>
	<script>
	const current_dict={};

	function stripAccents(s) {
	  var translate = {
		"à":"a","á":"a","â":"a","ã":"a","ä":"a","å":"a","ç":"c","è":"e","é":"e","ê":"e","ë":"e","ì":"i","í":"i","î":"i","ï":"i","ñ":"n","ò":"o","ó":"o","ô":"o","õ":"o","ö":"o","ù":"u","ú":"u","û":"u","ü":"u","ý":"y","ÿ":"y"
	  };
	  var translate_re = /[àáâãäåçèéêëìíîïñòóôõöùúûüýÿ]/g;
	  return ( s.replace(translate_re, function(match) { 
		return translate[match]; 
	  }) );
	}
	
	function loadDict() {
	  let downloaded_size;
	  for (var i=5; i<=8; i++) {
		if (current_dict[i]==null) {
          let async= $.ajax({
			dataType: "json",
			cache: true,
			words_length: i,
			url: "fr/"+i+".json",
			async: false,
			success: function(data) {
              var i = this.words_length;
              current_dict[i]=data;
			}
          });
		}
	  }
	}
	function setCharAt(str,index,chr) {
      if(index > str.length-1) return str;
      return str.substr(0,index) + chr + str.substr(index+1);
	}

	function speak(text) {
	  if (sound) {
		const msg = new SpeechSynthesisUtterance();
		msg.volume = 1; // 0 to 1
		msg.rate = 1; // 0.1 to 10
		msg.pitch = 0; //0 to 2
		//msg.lang = 'fr-FR';
		msg.text=text.toLowerCase();
		speechSynthesis.speak(msg);
	  }
	}

	function sayLetter(letter) {
	  if (letter.match(/[a-zA-Z]/)) {
		speak(letter);
		$("td."+letter).css("background-color", "#FCA");
		setTimeout(()=>{
		  $("td."+letter).css("background-color", "transparent")
		}, 400);
	  }
	  if (mode=="mystery") {
		while((i=mystery.cleanedWord.indexOf(letter))>=0) {
		  mystery.mysteryWord=setCharAt(mystery.mysteryWord, i, mystery.cleanedWord[i]);
		  mystery.cleanedWord=setCharAt(mystery.cleanedWord, i, " ");
		}
		for (let i=0; i<mystery.mysteryWord.length;i++) {
		  $("#screen td.c"+(i+1)).text(mystery.mysteryWord[i]);
		}
		$("td."+letter).css("color", "#CCC");
		
		$("#screen").val(mystery.mysteryWord);
		if (mystery.cleanedWord.replace(/\s+/, '') == "") {
		  lastWord=mystery.word;
		  input=mystery.word;
		  speak(mystery.word);
		  speak("Bravo! tu as gagné !");
		}
	  } else {
		if (letter.match(/[a-zA-Z]/)) {
		  if (input.length<10) {
			input+=letter;
			$("#screen td.c"+input.length).text(letter);
		  }
		}
	  }
	}
	let input="";
	let lastWord="";
	let sound=true;
	loadDict();

    $("body").keydown(function (e) {
	  if (e.which == 8) {
		$("#screen td.c"+input.length).text("");
		input = input.slice(0, -1);
		return false;
	  } else {
		return true;
	  }
	});
	
    $("body").keypress(function (e) {
	  if (e.which == 13) {
		return false;
	  } else if (e.which>=65 && e.which<=122) {
		const chr = String.fromCharCode(e.which).toUpperCase();
		sayLetter(chr);
		return false;
	  } else {
		return true;
	  }
    });

	
	let mode="";
	let mystery={
	  "word": "",
	  "cleanedWord": ""
	};
	
	$("#options td").on("click", (e) => {
	  let opt = $(e.target).closest("td").attr('class');
	  if (opt.match(/sound/)) {
		if (opt.match(/on/)) {
		  sound=false;
		} else {
		  sound=true;
		}
		$(".sound i").toggleClass("fa-volume-up").toggleClass("fa-volume-off");
		$(".sound").toggleClass("on");
	  }
	});

	$(".keyboard td").on("click", (e) => {
	  let text = $(e.target).text();
	  if (text.length==1) {
		sayLetter(text);		
	  } else {
		if (text=="Essaie") {
		  text=input;
		} else if (text=="Efface") {
		  $("#screen td").text("");
		  input="";
		  text="";
		} else if (text.match(/^clavier/)) {
		  const type = $(e.target).attr('class');
		  if (type.match(/azerty/)) {
			$(".azerty").addClass("selected");
			$("#keyboard-azerty").show();
			$(".abcdef").removeClass("selected");
			$("#keyboard-abcdef").hide();		
		  } else {
			$(".azerty").removeClass("selected");
			$("#keyboard-azerty").hide();
			$(".abcdef").addClass("selected");
			$("#keyboard-abcdef").show();		
		  }
		  text="";
		} else if (text=="Répète") {
		  text=lastWord;
		} else if (text=="Aide" && mode=="mystery") {
		  let word = mystery.cleanedWord.replace(/\s+/g, '');
		  if (word.length>0) {
			let index = Math.floor(Math.random()*word.length);
			sayLetter(word[index]);
		  }
		  text="";
		} else if (text=="Mystère" && mode=="mystery") {
		  mode="";
		  $("td.letter").css("color", "black");
		  lastWord="";
		  $("#screen td").text("");
		  $(".mystery").removeClass("selected");
		  input="";
		  text="";
		} else if (text=="Mystère" || (mode=="mystery" && text=="Rejoue")) {
		  $("td.letter").css("color", "black");
		  lastWord="";
		  input="";
		  const length = Math.floor(Math.random() * 4) + 5;
		  const index = parseInt(Math.random() * current_dict[length].length);
		  const infos=current_dict[length][index].split(" ");
		  mystery.word=infos[1];
		  mystery.cleanedWord=stripAccents(infos[1]).toUpperCase();
		  mystery.mysteryWord=mystery.cleanedWord.replace(/./g, "_");
		  mode="mystery";
		  $("#screen td").text("");
		  for (let i=0; i<mystery.mysteryWord.length;i++) {
			$("#screen td.c"+(i+1)).text("_");
		  }
		  text="";
		  $(".mystery").addClass("selected");
		} else if (text=="Epelle") {
		  text=input.split('').join(", ");
		  speak(text);
		  text="";
		} else {
		  text="";
		}  
		if (text.length>0) {
		  lastWord=text;
		  speak(text);
		}
	  }
	});
  </script>
  </body>
</html>
