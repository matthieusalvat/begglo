<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
	<link rel="stylesheet" href="font-awesome-4.0.3/css/font-awesome.css">
	
    <title>Dictée Magique</title>
	<style>
	body {
	  width: 700px;
	  transform-origin: top left;
	}
	/* The Modal (background) */
	.modal {
      display: none; /* Hidden by default */
      position: fixed; /* Stay in place */
      z-index: 1; /* Sit on top */
      padding-top: 50px; /* Location of the box */
      left: 0;
      top: 0;
      width: 100%; /* Full width */
      height: 100%; /* Full height */
      overflow: auto; /* Enable scroll if needed */
      background-color: rgb(0,0,0); /* Fallback color */
      background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
	}

	/* Modal Content */
	.modal-content {
      background-color: #fefefe;
      margin: auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
	}
	
	body {
	  font-family: monospace;
	}
	
	#keyboard-type {
	  border-collapse: collapse;
	}
	
	#keyboard-type td, #keyboard-type th{
	  border:1px solid black;
	  width: 60px;
	  padding: 5px;
	}

	td.selected{
	  background-color: black;
	  color: white;
	}

	table {
	  border-collapse: separate;
	}

	#screen {
	  margin-bottom: 1em;
	}
	
	table td{
	  cursor: pointer;
	  width: 60px;
	  height: 60px;
	  border-collapse: 2px;
	  border:1px solid black;
	  border-radius: 5px 5px;
	  text-align:center;
	  vertical-align: middle;
	}

	td:hover{
	  background-color: #BBB;
	}

	#screen td:hover {
	  cursor: default;
	  background-color: transparent;
	}
	
	table td.letter{
	  font-size: 40PX;
	  font-weight: bold;
	}

	#options td {
	  width: 30px;
	  height: 30px;
	}
	</style>
  </head>
  <body>
	<table id="options">
	  <tr>
		<td class="sound on">
		  <i class="fa fa-volume-up fa-lg"></i>
		</td>
		<td class="dictionnary">
		  <select id="dictionnaries"></select>
		  <span id="customDiv" style="display:none;"><a href="#" id="editCustomDict">Editer votre dictionnaire</a></span>
		</td>
	  </tr>
	</table>
	<div id="customDict" class="modal" style="display: none">
	  <div class="modal-content">
		Voici votre dictionnaire personnel (un mot par ligne):<br/>
		<textarea style="width: 100%" rows="20" id="customWordsList"></textarea><br/>
		<p>Les mots de plus de 10 lettres ne seront pas pris en compte</p>		
		<p>Attention : Il est seulement enregistré sur votre poste</p>
		<button id="cancelDict">Annuler</button>
		<button id="saveDict">Sauvegarder</button>
	  </div>
	</div>
	<table id="screen">
	  <tr id="line1">
		<td class="letter c1"></td>
		<td class="letter c2"></td>
		<td class="letter c3"></td>
		<td class="letter c4"></td>
		<td class="letter c5"></td>
		<td class="letter c6"></td>
		<td class="letter c7"></td>
		<td class="letter c8"></td>
		<td class="letter c9"></td>
		<td class="letter c10"></td>
	  </tr>
	</table>
	<table class="keyboard" id="keyboard-abcdef">
	  <tr>
		<td class="azerty">clavier<br/>AZERTY</td><td class="abcdef selected">clavier<br/>ABCDEF</td>		
		<td>Rejoue</td><td>Répète</td><td>Aide</td>
		<td class="mystery">Mystère</td><td>Secret</td><td>Lettre</td><td>Dis-le</td><td>Epelle</td>
	  </tr>
	  <tr>
		<td class="letter A">A</td><td class="letter B">B</td><td class="letter C">C</td><td class="letter D">D</td><td class="letter E">E</td>
		<td class="letter F">F</td><td class="letter G">G</td><td class="letter H">H</td><td class="letter I">I</td><td class="letter J">J</td>
	  </tr>
	  <tr>
		<td class="letter K">K</td><td class="letter L">L</td><td class="letter M">M</td><td class="letter N">N</td><td class="letter O">O</td>
		<td class="letter P">P</td><td class="letter Q">Q</td><td class="letter R">R</td><td class="letter S">S</td><td class="letter T">T</td>
	  </tr>
	  <tr>
		<td class="letter U">U</td><td class="letter V">V</td><td class="letter W">W</td><td class="letter X">X</td><td class="letter Y">Y</td>
		<td class="letter Z">Z</td><td class="letter ">'</td><td class="letter">#</td><td>Efface</td><td>Essaie</td>
	  </tr>
	</table>
	<table class="keyboard" id="keyboard-azerty" style="display: none">
	  <tr>
		<td class="azerty">clavier<br/>AZERTY</td><td class="abcdef selected">clavier<br/>ABCDEF</td>		
		<td>Rejoue</td><td>Répète</td><td>Aide</td>
		<td>Mystère</td><td>Secret</td><td>Lettre</td><td>Dis-le</td><td>Epelle</td>
	  </tr>
	  <tr>
		<td class="letter A">A</td><td class="letter Z">Z</td><td class="letter E">E</td><td class="letter R">R</td><td class="letter T">T</td>
		<td class="letter Y">Y</td><td class="letter U">U</td><td class="letter I">I</td><td class="letter O">O</td><td class="letter P">P</td>
	  </tr>
	  <tr>
		<td class="letter Q">Q</td><td class="letter S">S</td><td class="letter D">D</td><td class="letter F">F</td><td class="letter G">G</td>
		<td class="letter H">H</td><td class="letter J">J</td><td class="letter K">K</td><td class="letter L">L</td><td class="letter M">M</td>
	  </tr>
	  <tr>
		<td class="letter W">W</td><td class="letter X">X</td><td class="letter C">C</td><td class="letter V">V</td><td class="letter B">B</td>
		<td class="letter N">N</td><td class="letter ">'</td><td class="letter">#</td><td>Efface</td><td>Essaie</td>
	  </tr>
	</table>
	<p>Utilisez plutôt Chrome pour avoir une jolie synthèse vocale (celle de Firefox est vraiment mauvaise hélas)</p>
	<script>
	const dictionnaries={
	  "sNs1" :{
		name: "Dictée Magique standard (123 mots)",
		words: ["BANANE","CHOU","COURSE","DIMANCHE","FRITURE","GENOU","LARGEUR","LIMONADE","MADAME","MATIN","ONCLE","PLAGE","POIRE","RETIRER","ROI","ROSE","SALADE","SAVON","SOLIDE","SOUCOUPE","SOUPE","TABLE","TOILE","VACHE","VESTE","VIRAGE","COCHON","DANSEUR","DIVISION","DROIT","JOIE","LANGUE","LINGE","MAISON","MONTAGE","MOUSSE","POULETTE","ROUILLE","SALADIER","SALIVE","SAUVAGE","SOMBRE","SOMME","SOULIER","TABLETTE","TIMBRE","TRANCHE","ALLIAGE","BONBON","BROUILLE","CAUSER","CENTAINE","COLLIER","FREIN","GRAIN","LONGUEUR","MAILLOT","MANTEAU","MARRON","MIEUX","MILLION","MURAILLE","NAVIGUER","NOUILLE","OISEAU","PALETOT","PAYSANNE","PLAIRE","PLAISIR","PLUIE","RESSORT","SOUVENT","TIMBALE","TONNEAU","TRAVAIL","TREIZE","UNIQUE","VIEUX","VILLAGE","VINAIGRE","VRAIMENT","CONDUIRE","BERCER","CADEAU","CHAPEAU","COUREUR","DOMMAGE","FRAISE","ABATTRE","ACCABLER","ANNEAU","ASSOMMER","BERCEAU","BONHEUR","CANOT","CHIFFRE","CUEILLIR","EXISTER","HABILLER","MAGASIN","MAGAZINE","MISOGYNE","NATION","NOURRIR","OCCASION","PANNEAU","POURRIR","QUATORZE","RAPPELER","RESPECT","SAUCISSE","SCULPTER","SOIXANTE","SOUCIEUX","SOUFFLE","STYLO","SYLLABE","TISSU","TRAPPE","WAGONNET","YAOURT","ZIGZAG","ZODIAQUE"
		]
	  },
	  "sNs2" : {
		name: "Dictée Magique étendue (203 mots)",
		words: ["ABSCISSE","AMERRIR","AMPHIBIE","ANALYSE","ABHORRER","APPENTIS","ACACIA","ACCOLER","ACHOPPER","AFFLIGER","APPRENTI","AHURI","ATOLL","ALMANACH","AUTOPSIE","AMANDIER","BAHUT","BOMBYX","ABSENCE","ACCROC","AFFALER","AQUEUX","AFFOLER","ANCHOIS","APAISER","AFFUBLER","AGGRAVER","AGRAFER","AGRANDIR","APITOYER","APLATIR","APLOMB","APPELER","AISSELLE","ALAMBIC","APPLIQUE","APPOSER","AMENDER","APHONE","ALLAITER","ASPECT","ATTACHER","AQUARIUM","CANETTE","BUFFLE","CANNELLE","CAHOTEUX","CANONNER","CAJOLER","CEINDRE","CALOTTE","CARROSSE","CHARIOT","CERVELAS","CHLORURE","CHARRUE","CHORISTE","COOPTER","CYCLAMEN","CHROME","CINTRE","CYMBALE","ATTEINTE","ATTENTE","BALEINE","BAZAR","CHOPE","ARTHRITE","ÀSSOMMER","CABALE","CALANDRE","CALVAIRE","CALVITIE","CITHARE","COHORTE","COLLOQUE","BONBONNE","BONHOMME","BOUILLIR","CRISTAL","CANARI","CYLINDRE","DYSLEXIE","CUNIQUE","EMBARRAS","ERMITE","EMBRAYER","DIAPNANE","ENRHUMER","HALETANT","HAMEAU","ENZYME","DILEMME","ERGOT","DISCIPLINE","HANDICAP","ESQUIMAU","DYNAMITE","HANGAR","ETHNIE","EXQUIS","HARGNEUX","EXALTER","EXHALER","EXHIBER","EXIGEANT","EXULTER","ENTONNER","ESCROC","FALLOIR","FATIGANT","HACHURE","HAGARD","HARASSER","HASARD","HARPON","HERNIE","HEXAGONE","HIATUS","FAUNE","HOMARD","INEPTIE","HOMMAGE","HONNEUR","INERTIE","IRIDIUM","IRRITANT","HONORER","LYNX","HARCELER","HERMINE","HINDOU","HORREUR","MATELAS","HIPPIQUE","HOSTILE","MUFLE","HOUBLON","HUILEUX","MYOPIE","HORMONE","HYBRIDE","HOMONYME","HUMILIER","HYDROMEL","HYMNE","IDIOTIE","PANARIS","PHALANGE","PHARAON","PILOTIS","POLYGONE","RYTHME","ORTIE","OSCILLER","FEINDRE","HYMEN","HYPNOSE","PARLOTE","INDIEN","SCEPTRE","INDIGENT","SCHISTE","SCIENCE","SIPHON","SOURCIL","PSYCHOSE","PYRAMIDE","RAFLER","SPHINX","RHUBARBE","SYNONYME","RISQUE","TYPHON","SALSIFIS","SAPHIR","SARRASIN","SALOIR","VACILLER","TROMBONE","VOSGIEN","AMERRIR","FATRAS","GAUFRE","GIBOYEUX","GLYCINE","INDEMNE","MAROTTE","MOLETTE","MOLLESSE","MYOSOTIS","MYRTILLE","PEINTRE","PENSUM","PHLEGMON","ONGUENT","SPATIAL","SURSIS","SUSCITER","SYNCOPE","SYNTAXE","TYMPAN","TYPHUS","TYPIQUE"]
	  },
	  "begglo" : {
		name: "Dictionnaire français complet (hunspell)",
		words: []
	  },
	  "custom": {
		name: "Votre dictionnaire",
		words: []
	  }
	};
	let currentDict="begglo";
	if (localStorage.getItem("currentDict")) {
	  currentDict=localStorage.getItem("currentDict");
	}
	if (localStorage.getItem("customDict")) {
	  let customWords=localStorage.getItem("customDict").split(/\r|\n/g);
	  customWords = customWords.filter(w =>  w.length>0 && w.length<11 ); 
	  dictionnaries.custom.words=customWords;
	  $("#customWordsList").val(customWords.join("\n"));
	}
	
	for (let dictId in dictionnaries) {
	  const opt = $("<option>").val(dictId).text(dictionnaries[dictId].name);
	  if (dictId == currentDict) {
		opt.attr("selected", "selected");
		if (currentDict == "custom") {
		  $("#customDiv").show();
		  opt.text(dictionnaries[dictId].name+" ("+dictionnaries.custom.words.length+" mots)");
		}
	  }
	  $("#dictionnaries").append(opt);
	}

	const bw=$("body").width();
	const bh=$("body").height();
	function resize() {
	  const ww=$(window).width();
	  const wh=$(window).height();
	  const ratiow=ww/bw;
	  const ratioh=wh/bh;
	  console.log("window", ww, wh);
	  
	  console.log("body", bw, bh);
	  console.log("ratio", ww/bw, wh/bh);
	  if (ratiow<ratioh) {
		$("body").css("transform", "scale("+ratiow+")");
		//$("body").css({scale: ratiow});
	  } else {
		//$("body").css({scale: ratioh});
		$("body").css("transform", "scale("+ratioh+")");
	  }
	  
	}

	resize();
	$(window).resize(resize);
	  
	$("#saveDict").on("click", () => {
	  let customWords=$("#customWordsList").val().split(/\r|\n/g);
	  customWords = customWords.filter(w =>  w.length>0); 
	  dictionnaries.custom.words=customWords;
	  $('#dictionnaries option[value="custom"]').text(dictionnaries.custom.name+" ("+dictionnaries.custom.words.length+" mots)");
	  localStorage.setItem("customDict", $("#customWordsList").val());
	  $("#customDict").hide();
	});

	$("#editCustomDict").on("click", () => {
	  $("#customDict").show();
	});
	
	$("#cancelDict").on("click", () => {
	  $("#customDict").hide();
	});
	
	function stripAccents(s) {
	  var translate = {
		"à":"a","á":"a","â":"a","ã":"a","ä":"a","å":"a","ç":"c","è":"e","é":"e","ê":"e","ë":"e","ì":"i","í":"i","î":"i","ï":"i","ñ":"n","ò":"o","ó":"o","ô":"o","õ":"o","ö":"o","ù":"u","ú":"u","û":"u","ü":"u","ý":"y","ÿ":"y"
	  };
	  var translate_re = /[àáâãäåçèéêëìíîïñòóôõöùúûüýÿ]/g;
	  return ( s.replace(translate_re, function(match) { 
		return translate[match]; 
	  }) );
	}
	
	function loadDict() {
	  let downloaded_size;
	  for (var i=5; i<=8; i++) {
		if (dictionnaries.begglo.words[i]==null) {
          let async= $.ajax({
			dataType: "json",
			cache: true,
			words_length: i,
			url: "fr/"+i+".json",
			async: false,
			success: function(data) {
              var i = this.words_length;
              dictionnaries.begglo.words[i]=data;
			}
          });
		}
	  }
	}
	function setCharAt(str,index,chr) {
      if(index > str.length-1) return str;
      return str.substr(0,index) + chr + str.substr(index+1);
	}

	function speak(text) {
	  if (sound) {
		const msg = new SpeechSynthesisUtterance();
		msg.volume = 1; // 0 to 1
		msg.rate = 1; // 0.1 to 10
		msg.pitch = 0; //0 to 2
		//msg.lang = 'fr-FR';
		msg.text=text.toLowerCase();
		speechSynthesis.speak(msg);
	  }
	}

	$("#dictionnaries" ).on( "change", () => {
	  currentDict=$("#dictionnaries option:selected").val();
	  localStorage.setItem("currentDict", currentDict);	  
	  if (currentDict == "custom") {
		$("#customDiv").show();
	  } else {
		$("#customDiv").hide();
	  }
	  
	});

	function sayLetter(letter) {
	  if (letter.match(/[a-zA-Z]/)) {
		speak(letter);
		$("td."+letter).css("background-color", "#FCA");
		setTimeout(()=>{
		  $("td."+letter).css("background-color", "transparent")
		}, 400);
	  }
	  if (mode=="mystery") {
		while((i=mystery.cleanedWord.indexOf(letter))>=0) {
		  mystery.mysteryWord=setCharAt(mystery.mysteryWord, i, mystery.cleanedWord[i]);
		  mystery.cleanedWord=setCharAt(mystery.cleanedWord, i, " ");
		}
		for (let i=0; i<mystery.mysteryWord.length;i++) {
		  $("#screen td.c"+(i+1)).text(mystery.mysteryWord[i]);
		}
		$("td."+letter).css("color", "#CCC");
		
		$("#screen").val(mystery.mysteryWord);
		if (mystery.cleanedWord.replace(/\s+/, '') == "") {
		  lastWord=mystery.word;
		  input=mystery.word;
		  speak(mystery.word);
		  speak("Bravo! tu as gagné !");
		}
	  } else {
		if (letter.match(/[a-zA-Z]/)) {
		  if (input.length<10) {
			input+=letter;
			$("#screen td.c"+input.length).text(letter);
		  }
		}
	  }
	}
	let input="";
	let lastWord="";
	let sound=true;
	loadDict();

    $(".keyboard").keydown(function (e) {
	  if (e.which == 8) {
		$("#screen td.c"+input.length).text("");
		input = input.slice(0, -1);
		return false;
	  } else {
		return true;
	  }
	});
	
    $(".keyboard").keypress(function (e) {
	  if (e.which == 13) {
		return false;
	  } else if (e.which>=65 && e.which<=122) {
		const chr = String.fromCharCode(e.which).toUpperCase();
		sayLetter(chr);
		return false;
	  } else {
		return true;
	  }
    });

	
	let mode="";
	let mystery={
	  "word": "",
	  "cleanedWord": ""
	};
	
	$("#options td").on("click", (e) => {
	  let opt = $(e.target).closest("td").attr('class');
	  if (opt.match(/sound/)) {
		if (opt.match(/on/)) {
		  sound=false;
		} else {
		  sound=true;
		}
		$(".sound i").toggleClass("fa-volume-up").toggleClass("fa-volume-off");
		$(".sound").toggleClass("on");
	  }
	});

	$(".keyboard td").on("click", (e) => {
	  let text = $(e.target).text();
	  if (text.length==1) {
		sayLetter(text);		
	  } else {
		if (text=="Essaie") {
		  text=input;
		} else if (text=="Efface") {
		  $("#screen td").text("");
		  input="";
		  text="";
		} else if (text.match(/^clavier/)) {
		  const type = $(e.target).attr('class');
		  if (type.match(/azerty/)) {
			$(".azerty").addClass("selected");
			$("#keyboard-azerty").show();
			$(".abcdef").removeClass("selected");
			$("#keyboard-abcdef").hide();		
		  } else {
			$(".azerty").removeClass("selected");
			$("#keyboard-azerty").hide();
			$(".abcdef").addClass("selected");
			$("#keyboard-abcdef").show();		
		  }
		  text="";
		} else if (text=="Répète") {
		  text=lastWord;
		} else if (text=="Aide" && mode=="mystery") {
		  let word = mystery.cleanedWord.replace(/\s+/g, '');
		  if (word.length>0) {
			let index = Math.floor(Math.random()*word.length);
			sayLetter(word[index]);
		  }
		  text="";
		} else if (text=="Mystère" && mode=="mystery") {
		  mode="";
		  $("td.letter").css("color", "black");
		  lastWord="";
		  $("#screen td").text("");
		  $(".mystery").removeClass("selected");
		  input="";
		  text="";
		} else if (text=="Mystère" || (mode=="mystery" && text=="Rejoue")) {
		  $("td.letter").css("color", "black");
		  lastWord="";
		  input="";
		  if (currentDict == "begglo") {
			const length = Math.floor(Math.random() * 4) + 5;
			const index = parseInt(Math.random() * dictionnaries.begglo.words[length].length);
			const infos=dictionnaries.begglo.words[length][index].split(" ");
			mystery.word=infos[1];
		  } else {
			const index = parseInt(Math.random() * dictionnaries[currentDict].words.length);
			mystery.word=dictionnaries[currentDict].words[index];
		  }
		  
		  mystery.cleanedWord=stripAccents(mystery.word).toUpperCase();
		  mystery.mysteryWord=mystery.cleanedWord.replace(/./g, "_");
		  mode="mystery";
		  $("#screen td").text("");
		  for (let i=0; i<mystery.mysteryWord.length;i++) {
			$("#screen td.c"+(i+1)).text("_");
		  }
		  text="";
		  $(".mystery").addClass("selected");
		} else if (text=="Epelle") {
		  text=input.split('').join(", ");
		  speak(text);
		  text="";
		} else {
		  text="";
		}  
		if (text.length>0) {
		  lastWord=text;
		  speak(text);
		}
	  }
	});
  </script>
  </body>
</html>
